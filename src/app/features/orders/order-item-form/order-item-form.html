<!-- Modal para agregar item a la orden - Pantalla completa -->
<div class="modal-overlay-fullscreen">
  <div class="modal-content-fullscreen">
    <div class="modal-header-fullscreen">
      <div class="header-content">
        <button class="back-button" (click)="onClose()">
          <mat-icon>arrow_back</mat-icon>
          <span>Volver a Mesas</span>
        </button>
        <h2>
          <mat-icon>add_shopping_cart</mat-icon>
          Agregar Producto a la Orden #{{ orderId }}
        </h2>
      </div>
      <button mat-icon-button class="close-button" (click)="onClose()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-body-fullscreen">
      <!-- Inicia: Mensaje de estado de orden entregada -->
      @if (isOrderDelivered()) {
      <div class="order-status-warning">
        <mat-icon>warning</mat-icon>
        <span>{{ getOrderStatusMessage() }}</span>
      </div>
      }
      <!-- Finaliza -->
      <!-- Se deshabilita agregar producto cuando la orden esté entregada -->
      <div class="form-container-fullscreen">
        <mat-card class="form-card-fullscreen" [ngClass]="{'disabled-form': !isFormEnabled()}">
          <mat-card-content>
            <form [formGroup]="itemForm" (ngSubmit)="onSubmit()">
              <!-- Selector de producto -->
              <div class="form-field-fullscreen">
                <label class="field-label">Producto *</label>
                <app-custom-dropdown [options]="productDropdownOptions"
                  [selectedValue]="itemForm.get('productId')?.value" placeholder="Selecciona un producto"
                  [loading]="loading"
                  [error]="itemForm.get('productId')?.hasError('required') && itemForm.get('productId')?.touched ? 'Selecciona un producto' : ''"
                  [disabled]="loading || !isFormEnabled()" [searchable]="true" size="medium" variant="outlined"
                  color="primary" (selectionChange)="onProductSelectionChange($event)">
                </app-custom-dropdown>
              </div>

              <!-- Campo de cantidad -->
              <mat-form-field appearance="outline" class="form-field-fullscreen">
                <mat-label>Cantidad</mat-label>
                <input matInput type="number" formControlName="quantity" placeholder="Ingrese la cantidad" min="1"
                  [disabled]="!selectedProduct || !isFormEnabled()" (input)="onQuantityChange()" />
                @if (itemForm.get('quantity')?.hasError('required') &&
                itemForm.get('quantity')?.touched) {
                <mat-error>La cantidad es requerida</mat-error>
                } @if (itemForm.get('quantity')?.hasError('min') &&
                itemForm.get('quantity')?.touched) {
                <mat-error>La cantidad debe ser mayor a 0</mat-error>
                }
              </mat-form-field>

              <!-- Preview del producto seleccionado -->
              @if (selectedProduct && itemForm.get('quantity')?.value) {
              <div class="product-preview-fullscreen">
                <div class="preview-header">
                  <mat-icon class="preview-icon">preview</mat-icon>
                  <span class="preview-title">Vista Previa del Pedido</span>
                </div>
                <div class="preview-content">
                  <div class="preview-row">
                    <span class="preview-label">Producto:</span>
                    <span class="preview-value">{{ selectedProduct.name }}</span>
                  </div>
                  <div class="preview-row">
                    <span class="preview-label">Código de Inventario:</span>
                    <span class="preview-value">{{ selectedProduct.code }}</span>
                  </div>
                  <div class="preview-row">
                    <span class="preview-label">Precio Unitario:</span>
                    <span class="preview-value price">{{ selectedProduct.price | currency:'COP':'symbol':'1.0-0'
                      }}</span>
                  </div>
                  <div class="preview-row">
                    <span class="preview-label">Cantidad:</span>
                    <span class="preview-value">{{ itemForm.get('quantity')?.value }}</span>
                  </div>
                  <div class="total-row">
                    <span class="preview-label">Total:</span>
                    <span class="preview-value total">{{ (selectedProduct.price * itemForm.get('quantity')?.value) |
                      currency:'COP':'symbol':'1.0-0' }}</span>
                  </div>
                </div>
              </div>
              }

              <!-- Botón para recargar productos si hay error -->
              @if (error) {
              <div class="error-actions">
                <button type="button" mat-raised-button color="warn" (click)="loadProducts()"
                  [disabled]="!isFormEnabled()">
                  <mat-icon>refresh</mat-icon>
                  Reintentar cargar productos
                </button>
              </div>
              }

              <div class="form-actions-fullscreen">
                <button type="button" class="btn-secondary" (click)="onClose()">
                  <mat-icon>arrow_back</mat-icon>
                  Volver
                </button>
                @if (isFormEnabled()) {
                <button type="button" class="btn-neutral" (click)="resetForm()">
                  <mat-icon>refresh</mat-icon>
                  Limpiar
                </button>
                <button type="button" class="btn-debug" (click)="debugInventoryCodes()" *ngIf="products.length > 0">
                  <mat-icon>bug_report</mat-icon>
                  Debug Códigos
                </button>
                <button type="submit" class="btn-primary" [disabled]="itemForm.invalid || loading">
                  <mat-icon>add_shopping_cart</mat-icon>
                  Agregar Producto
                </button>
                }
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </div>
</div>